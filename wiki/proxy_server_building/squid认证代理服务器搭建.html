<!DOCTYPE html>
<html lang='zh-CN'>


<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0" theme-name="Stellar" theme-version="1.25.0">
  
  <meta name="generator" content="Hexo 7.1.1">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>代理服务器搭建：squid内网认证代理服务器 - Misc010</title>

  
    <meta name="description" content="参考 搭建需要身份认证的 Squid 代理 Linux搭建squid服务实现内网机器代理上网 拓展阅读 万字长文带你了解最常用的开源 Squid 代理服务器｜2021 年中总结 针对外网的代理配置  squid安装与基础命令  环境：centos 1234[root@localhost squid]# cat &#x2F;etc&#x2F;redhat-releaseCentOS Linux release 7.9">
<meta property="og:type" content="website">
<meta property="og:title" content="squid内网认证代理服务器">
<meta property="og:url" content="https://misc0101.github.io/wiki/proxy_server_building/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA.html">
<meta property="og:site_name" content="Misc010">
<meta property="og:description" content="参考 搭建需要身份认证的 Squid 代理 Linux搭建squid服务实现内网机器代理上网 拓展阅读 万字长文带你了解最常用的开源 Squid 代理服务器｜2021 年中总结 针对外网的代理配置  squid安装与基础命令  环境：centos 1234[root@localhost squid]# cat &#x2F;etc&#x2F;redhat-releaseCentOS Linux release 7.9">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325150254514.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325150412299.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325160609627.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325161410331.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325161456672.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325150057249.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325162120741.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325162331495.png">
<meta property="article:published_time" content="2023-03-22T06:58:13.000Z">
<meta property="article:modified_time" content="2023-03-22T06:58:13.000Z">
<meta property="article:author" content="Misc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://misc0101.github.io/Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325150254514.png">
  
  
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  

  

  
  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='wiki'>
    

  




<div class="widgets"><widget class="widget-wrapper logo-wrap wiki"><div class="widget-body"><a style="filter: grayscale(100%)" class="wiki-home cap" href="/wiki"><svg aria-hidden="true" viewBox="0 0 16 16" width="1.2em" height="1.2em" fill="currentColor"><path fill-rule="evenodd" d="M7.78 12.53a.75.75 0 01-1.06 0L2.47 8.28a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L4.81 7h7.44a.75.75 0 010 1.5H4.81l2.97 2.97a.75.75 0 010 1.06z"></path></svg>所有项目</a><a class="title" href="/wiki/proxy_server_building/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA.html"><div class="main" ff="title">代理服务器搭建</div></a></div></widget>
<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search-wrapper"><form class="search-form"><input type="text" class="search-input" id="search-input" data-filter="/wiki/proxy_server_building/" placeholder="在/wiki/proxy_server_building/中搜索..."><svg t="1705074644177" class="icon search-icon" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div></div></widget>


<widget class="widget-wrapper toc multi" id="data-toc" collapse="false"><div class="widget-body fs14"><div class="doc-tree active"><a class="doc-tree-link active" href="/wiki/proxy_server_building/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA.html#start"><span class="toc-text">squid内网认证代理服务器</span></a><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text"> 参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#squid%E5%AE%89%E8%A3%85%E4%B8%8E%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4"><span class="toc-text"> squid安装与基础命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86"><span class="toc-text"> 配置认证代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-text"> 一个例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%85%8D%E7%BD%AE%E6%9C%AA%E8%AF%95%E5%8F%AA%E6%98%AF%E8%AE%B0%E5%BD%95"><span class="toc-text"> 进阶配置（未试，只是记录）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86"><span class="toc-text"> 使用代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows"><span class="toc-text"> Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux"><span class="toc-text"> Linux</span></a></li></ol></li></ol></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/proxy_server_building/TMG%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8.html"><span class="toc-text">TMG代理服务器</span></a></div></div></widget>

<widget class="widget-wrapper related"><div class="widget-header cap theme dis-select"><span class="name">更多：环境搭建</span></div><div class="widget-body related-posts"><a class="item wiki" href="/wiki/SIEM_env_building/Arcisght.html"><span class="title">SIEM环境搭建</span><span class="excerpt">目前包含：Splunk、Arcisght Recon。</span></a><a class="item wiki" href="/wiki/linux_env/chrony%E6%97%B6%E9%97%B4%E6%9C%8D%E5%8A%A1%E5%99%A8.html"><span class="title">Linux下的环境搭建</span><span class="excerpt">目前包含：chrony时间服务器。</span></a><a class="item wiki" href="/wiki/network_security_devices_env/Sophos_Firewall.html"><span class="title">安全设备类环境搭建</span><span class="excerpt">目前包含：Sophos Firewall，SonicWALL SMA设备，Juniper SRX设备，FortiGate VM，Cisco ACS，Cisco ISE。</span></a><a class="item wiki" href="/wiki/sql_injection_env/SQLite.html"><span class="title">SQL注入靶场环境搭建</span><span class="excerpt">目前包含：Oracle、PostgreSQL、Microsoft Access、SQLite。</span></a><a class="item wiki" href="/wiki/windows_env/%E5%9F%9F%E7%8E%AF%E5%A2%83.html"><span class="title">Windows下的环境搭建</span><span class="excerpt">目前包含：域环境(powershell方式和手动方式)，Exchange邮箱服务器(2016，2019)，IIS。</span></a></div></widget>
</div>


    </aside>
    <div class='l_main'>
      
  





      


<div class="bread-nav fs12"><div class="left"><div id="breadcrumb"><a class="cap breadcrumb" id="home" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki/">项目</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/proxy_server_building/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA.html">代理服务器搭建</a></div><div id="post-meta">
    <span>更新于&nbsp;<time datetime="2023-03-22T06:58:13.000Z">2023-03-22</time></span>
    </div></div></div>

<article class='md-text content wiki'>
<h1 class="article-title"><span>squid内网认证代理服务器</span></h1>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<p><a target="_blank" rel="noopener" href="https://maoxian.de/2016/06/1415.html">搭建需要身份认证的 Squid 代理</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/zhangxueliang/2970035">Linux搭建squid服务实现内网机器代理上网</a></p>
<p>拓展阅读</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6974225297952473095">万字长文带你了解最常用的开源 Squid 代理服务器｜2021 年中总结</a></p>
<p><a target="_blank" rel="noopener" href="http://www.linuxfly.org/post/128/">针对外网的代理配置</a></p>
<h2 id="squid安装与基础命令"><a class="markdownIt-Anchor" href="#squid安装与基础命令"></a> squid安装与基础命令</h2>
<blockquote>
<p>环境：centos</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost squid]# cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.9.2009 (Core)</span><br><span class="line">[root@localhost user]# uname -a</span><br><span class="line">Linux localhost.localdomain 3.10.0-1160.el7.x86_64 #1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y squid</span><br></pre></td></tr></table></figure>
<p>查看是否安装，将在已安装软件包中查找包含&quot;squid&quot;的软件包，并将其列出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep squid</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置文件<br />
squid配置文件位于<code>/etc/squid/squid.conf</code>，另外，该目录下有<code>/etc/squid/squid.conf.default</code>文件，是默认配置，修改squid.conf后想还原就用default文件覆盖回去。</p>
<p>以下是<code>squid.conf</code>文件的内容和各sections解读</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Recommended minimum configuration:</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Example rule allowing access from your local networks.</span><br><span class="line"># Adapt to list your (internal) IP networks from where browsing</span><br><span class="line"># should be allowed</span><br><span class="line">acl localnet src 10.0.0.0/8	# RFC1918 possible internal network</span><br><span class="line">acl localnet src 172.16.0.0/12	# RFC1918 possible internal network</span><br><span class="line">acl localnet src 192.168.0.0/16	# RFC1918 possible internal network</span><br><span class="line">acl localnet src fc00::/7       # RFC 4193 local private network range</span><br><span class="line">acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines</span><br><span class="line"></span><br><span class="line">acl SSL_ports port 443</span><br><span class="line">acl Safe_ports port 80		# http</span><br><span class="line">acl Safe_ports port 21		# ftp</span><br><span class="line">acl Safe_ports port 443		# https</span><br><span class="line">acl Safe_ports port 70		# gopher</span><br><span class="line">acl Safe_ports port 210		# wais</span><br><span class="line">acl Safe_ports port 1025-65535	# unregistered ports</span><br><span class="line">acl Safe_ports port 280		# http-mgmt</span><br><span class="line">acl Safe_ports port 488		# gss-http</span><br><span class="line">acl Safe_ports port 591		# filemaker</span><br><span class="line">acl Safe_ports port 777		# multiling http</span><br><span class="line">acl CONNECT method CONNECT</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Recommended minimum Access Permission configuration:</span><br><span class="line">#</span><br><span class="line"># Deny requests to certain unsafe ports</span><br><span class="line">http_access deny !Safe_ports</span><br><span class="line"></span><br><span class="line"># Deny CONNECT to other than secure SSL ports</span><br><span class="line">http_access deny CONNECT !SSL_ports</span><br><span class="line"></span><br><span class="line"># Only allow cachemgr access from localhost</span><br><span class="line">http_access allow localhost manager</span><br><span class="line">http_access deny manager</span><br><span class="line"></span><br><span class="line"># We strongly recommend the following be uncommented to protect innocent</span><br><span class="line"># web applications running on the proxy server who think the only</span><br><span class="line"># one who can access services on &quot;localhost&quot; is a local user</span><br><span class="line">#http_access deny to_localhost</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Example rule allowing access from your local networks.</span><br><span class="line"># Adapt localnet in the ACL section to list your (internal) IP networks</span><br><span class="line"># from where browsing should be allowed</span><br><span class="line">http_access allow localnet</span><br><span class="line">http_access allow localhost</span><br><span class="line"></span><br><span class="line"># And finally deny all other access to this proxy</span><br><span class="line">http_access deny all</span><br><span class="line"></span><br><span class="line"># Squid normally listens to port 3128</span><br><span class="line">http_port 3128</span><br><span class="line"></span><br><span class="line"># Uncomment and adjust the following to add a disk cache directory.</span><br><span class="line">#cache_dir ufs /var/spool/squid 100 16 256</span><br><span class="line"></span><br><span class="line"># Leave coredumps in the first cache dir</span><br><span class="line">coredump_dir /var/spool/squid</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Add any of your own refresh_pattern entries above these.</span><br><span class="line">#</span><br><span class="line">refresh_pattern ^ftp:		1440	20%	10080</span><br><span class="line">refresh_pattern ^gopher:	1440	0%	1440</span><br><span class="line">refresh_pattern -i (/cgi-bin/|\?) 0	0%	0</span><br><span class="line">refresh_pattern .		0	20%	4320</span><br></pre></td></tr></table></figure>
<div class="tag-plugin tabs" align="center"id="tab_226"><div class="nav-tabs"><div class="tab active"><a href="#tab_226-1">简略版解读</a></div><div class="tab"><a href="#tab_226-2">详尽版解读</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_226-1"><ul>
<li>
<p>The first section sets up ACLs (Access Control Lists) for different types of networks and ports. The <code>acl localnet</code> lines define IP address ranges that are allowed to access the proxy, while the <code>acl SSL_ports</code> and <code>acl Safe_ports</code> lines specify which ports are allowed for HTTPS and other protocols respectively.</p>
</li>
<li>
<p>The second section specifies the minimum access permissions that should be configured for the proxy. The <code>http_access deny</code> lines restrict access to unsafe ports and disallow CONNECT to non-SSL ports, while <code>http_access allow</code> lines allow access to the local network and <code>localhost</code>.</p>
</li>
<li>
<p>The third section sets up the port that Squid listens on (default is 3128) and specifies the directory where core dumps should be stored in case of a crash.</p>
</li>
<li>
<p>The fourth section defines the refresh patterns for cached objects. These rules determine how long cached objects should be kept and how often they should be refreshed.</p>
</li>
</ul></div><div class="tab-pane" id="tab_226-2"><ol>
<li>
<p>ACL Section</p>
<ul>
<li>
<p>The <code>acl localnet</code> lines define IP address ranges that are allowed to access the proxy. By default, the ACL allows access from the RFC1918 private IP address ranges (10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16), as well as from the fc00::/7 and fe80::/10 address ranges.</p>
</li>
<li>
<p>The <code>acl SSL_ports</code> line specifies the HTTPS port (443) as the only port that should be allowed for secure connections.</p>
</li>
<li>
<p>The <code>acl Safe_ports</code> lines list several ports that should be allowed for various types of traffic, such as HTTP (port 80), FTP (port 21), HTTPS (port 443), and others.</p>
</li>
<li>
<p>The <code>acl CONNECT method CONNECT</code> line allows the CONNECT method, which is used for establishing SSL tunnel connections.</p>
</li>
</ul>
</li>
<li>
<p>Access Permission Section</p>
<ul>
<li>
<p>The <code>http_access deny</code> lines specify which types of requests should be denied. The <code>!Safe_ports</code> argument after <code>deny</code> blocks all requests to ports other than those listed in <code>Safe_ports</code>. The <code>CONNECT !SSL_ports</code> argument after <code>deny</code> blocks all SSL tunnel requests to non-HTTPS ports.</p>
</li>
<li>
<p>The <code>http_access allow</code> lines specify which types of requests should be allowed. The <code>localhost</code> argument after <code>allow</code> allows requests originating from the proxy host itself. The <code>localnet</code> argument after <code>allow</code> allows requests originating from the IP ranges defined in the <code>acl localnet</code> section.</p>
</li>
<li>
<p>The <code>http_access deny all</code> line blocks all other requests, effectively restricting access to the proxy to only those specified in the <code>http_access allow</code> lines.</p>
</li>
</ul>
</li>
<li>
<p>Port and Core Dump Directory Section</p>
<ul>
<li>The <code>http_port</code> line specifies the port on which Squid should listen for incoming connections. By default, this is set to port 3128.</li>
<li>The <code>coredump_dir</code> line specifies the directory where core dump files should be stored in case of a crash. By default, this is set to <code>/var/spool/squid</code>.</li>
</ul>
</li>
<li>
<p>Refresh Pattern Section<br />
The <code>refresh_pattern</code> lines specify how frequently Squid should check for new versions of cached objects. The first argument (<code>^ftp:</code> and <code>^gopher:</code>) specifies which types of requests the pattern should match. The second argument (1440 and 0) specifies the number of minutes after which Squid should check for updates. The third argument (20% and 0%) specifies the percentage of the object’s age that should be used to determine when to refresh the object. The fourth argument (10080 and 1440) specifies the maximum age of the object in minutes before it should be removed from the cache. The <code>-i (/cgi-bin/|\?)</code> line specifies a regular expression to match URLs that should never be cached, and the final <code>refresh_pattern .</code> line specifies that all other URLs should be refreshed according to the other refresh pattern rules.</p>
</li>
</ol></div></div></div>
<p><strong>端口</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Squid normally listens to port 3128</span><br><span class="line">http_port 3128</span><br></pre></td></tr></table></figure>
<p>默认端口3128。如果对外是动态分配的，则无法固定IP。如果需要对内部的局域网服务，可写成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_port 192.168.228.180:3128</span><br></pre></td></tr></table></figure>
<p><strong>访问控制列表</strong><br />
squid从上往下读取acl规则，当一个规则匹配到时，就会允许，就不再往下匹配，所以acl的顺序很重要。<br />
squid可通过IP地址、主机名、MAC地址、用户/密码认证等方式识别及控制对外访问，还可限制时间段等。</p>
<p>ACL的基本格式是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl 列表名称 控制方式 控制目标</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果是虚拟机环境，因为squid配置文件中默认允许私有地址192.168.0.0/16使用squid代理，所以只要确保squid启动，就能让其他内网虚拟机来使用该代理，<a href="##%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86">点此跳转到如何使用</a></p>
</blockquote>
<p><u><strong>不建议http_access allow all，直接放行所有http请求来源，如果是自己搭建的测试环境，则无所谓</strong></u><br />
<strong>检查配置文件</strong><br />
使用该命令检查配置是否有误，如果有误，会输出相应错误，如果无误，会输出具体配置信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">squid -k parse</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>防火墙放行3128端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">把 3128 端口加入防火墙过滤掉</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">firewall-cmd --permanent --zone=public --add-port=3128/tcp</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">重启防火墙</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">firewall-cmd --reload</span></span><br><span class="line"></span><br><span class="line">​	如果Squid在另一个非默认端口上运行，则需要允许该端口上的流量通过。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4. 基础命令</span><br><span class="line">   初始化服务（记一下，不一定要运行）</span><br><span class="line"></span><br><span class="line">   ~~~shell</span><br><span class="line">   squid -z</span><br></pre></td></tr></table></figure>
<p>启动、重启、开机自启动命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start squid</span><br><span class="line">systemctl restart squid</span><br><span class="line">systemctl enable squid</span><br></pre></td></tr></table></figure>
<p>查看squid状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status squid</span><br></pre></td></tr></table></figure>
<p>关闭时建议使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">squid -k shutdown</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>循环读取显示日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">squid -ztail -f /var/log/squid/access.log</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="配置认证代理"><a class="markdownIt-Anchor" href="#配置认证代理"></a> 配置认证代理</h2>
<ol>
<li>
<p>增加用户名密码的认证方式来做权限控制<br />
需要安装htpasswd，该工具集成在apache httpd的tools里</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd-tools -y</span><br></pre></td></tr></table></figure>
<p>安装完成之后执行 htpasswd，如果没有提示找不到命令，则说明安装成功。</p>
<p>接下来创建保存用户名密码的文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /etc/squid/squid_passwd</span><br><span class="line">chown squid /etc/squid/squid_passwd</span><br></pre></td></tr></table></figure>
<div class="tag-plugin colorful note" color="yellow"><div class="body"><p>注意授权的时候要弄清楚squid运行时的用户名，一般是squid或者proxy。</p></div></div>
<p>然后执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">htpasswd /etc/squid/squid_passwd username</span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password for user username</span><br></pre></td></tr></table></figure>
<p>注意把 username 换成你想要的用户名，密码位数不能超过8位。比如我这里账户名设username，密码为admin<br />
如果想要继续添加用户，请多次执行这条命令。</p>
<blockquote>
<p>命令格式：<br />
htpasswd [选项] 文件名 用户名</p>
<p>常用选项<br />
-c 创建新文件，如果没加此选项会把新增的用户添加在末尾<br />
-2 SHA-256格式的密码<br />
-5 SHA-512格式的密码<br />
-B bcrypt格式的密码<br />
-d CRYPT格式的密码<br />
-s SHA-1格式的密码</p>
</blockquote>
</li>
<li>
<p>查看验证文件，安装squid时会自动装上这个验证文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost user]# rpm -ql squid | grep ncsa</span><br><span class="line">/usr/lib64/squid/basic_ncsa_auth</span><br><span class="line">/usr/share/man/man8/basic_ncsa_auth.8.gz</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>测试密码文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost user]# /usr/lib64/squid/basic_ncsa_auth /etc/squid/squid_passwd</span><br><span class="line">username Admin@123</span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试完成，crtl + c 打断</span></span><br></pre></td></tr></table></figure>
<p>接下来修改 /etc/squid/squid.conf 文件让squid使用验证，在 http_access deny all 之前加上下面几句：</p>
<div class="tag-plugin tabs" align="center"id="tab_227"><div class="nav-tabs"><div class="tab active"><a href="#tab_227-1">注释版</a></div><div class="tab"><a href="#tab_227-2">直接复制版</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_227-1"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/squid_passwd  #选择的认证方式为basic，认证程序路径和密码文件路径</span><br><span class="line">                                                                                   #注意第一个文件路径要和刚才rpm -ql squid | grep ncsa找的路径一样，第二个文件路径是之前创建用于保存用户名密码的密码文件路径</span><br><span class="line">auth_param basic children 5                                                        #认证程序的进程数，最多5个账户同时运行</span><br><span class="line">auth_param basic realm Squid proxy-caching web server                              #用户输入用户名密码时看到的提示信息</span><br><span class="line">auth_param basic credentialsttl 2 hours                                            #认证有效时间，用户名和密码的缓存时间，也就是说同一个用户名多久会调用 ncsa_auth 一次</span><br><span class="line">auth_param basic casesensitive off                                                 #用户名是否需要匹配大小写</span><br><span class="line"></span><br><span class="line">acl ncsa_users proxy_auth REQUIRED                                                 #所有成功鉴权的用户都归于 ncsa_users 组</span><br><span class="line">http_access allow ncsa_users                                                       #允许 ncsa_users 组的用户使用 Proxy</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab_227-2"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/squid_passwd</span><br><span class="line">auth_param basic children 5</span><br><span class="line">auth_param basic realm Squid proxy-caching web server</span><br><span class="line">auth_param basic credentialsttl 2 hours</span><br><span class="line">auth_param basic casesensitive off</span><br><span class="line">acl ncsa_users proxy_auth REQUIRED</span><br><span class="line">http_access allow ncsa_users</span><br></pre></td></tr></table></figure></div></div></div>
</li>
</ol>
<div class="tag-plugin colorful note" color="green"><div class="title">提示</div><div class="body"><p>最后说一个小坑，apache httpd 2.2 版本和 2.4 版本的 htpasswd 生成的密码文件格式是不一样的。只有 2.2 版本的能用。</br>如果按照教程设置成功以后发现用户名密码死活不对，文件权限也没有问题的话，那就要看一下是不是 htpasswd 的问题了。</br> 直接输入 /usr/lib/squid/ncsa_auth /etc/squid/squid_passwd 然后输入 username passwd 可以手动运行一下 ncsa_auth 程序，看看是否是密码文件的问题。</br> 如果提示 OK 那么说明没有问题，提示 ERR Wrong password 则说明要么是密码输错了，要么是密码文件的格式有问题。</p></div></div>
<h2 id="一个例子"><a class="markdownIt-Anchor" href="#一个例子"></a> 一个例子</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/squid/squid.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Recommended minimum configuration:</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Example rule allowing access from your local networks.</span><br><span class="line"># Adapt to list your (internal) IP networks from where browsing</span><br><span class="line"># should be allowed</span><br><span class="line">acl localnet src 10.0.0.0/8	# RFC1918 possible internal network</span><br><span class="line">acl localnet src 172.16.0.0/12	# RFC1918 possible internal network</span><br><span class="line">acl localnet src 192.168.0.0/16	# RFC1918 possible internal network</span><br><span class="line">acl localnet src fc00::/7       # RFC 4193 local private network range</span><br><span class="line">acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines</span><br><span class="line"></span><br><span class="line">acl SSL_ports port 443</span><br><span class="line">acl Safe_ports port 80		# http</span><br><span class="line">acl Safe_ports port 21		# ftp</span><br><span class="line">acl Safe_ports port 443		# https</span><br><span class="line">acl Safe_ports port 70		# gopher</span><br><span class="line">acl Safe_ports port 210		# wais</span><br><span class="line">acl Safe_ports port 1025-65535	# unregistered ports</span><br><span class="line">acl Safe_ports port 280		# http-mgmt</span><br><span class="line">acl Safe_ports port 488		# gss-http</span><br><span class="line">acl Safe_ports port 591		# filemaker</span><br><span class="line">acl Safe_ports port 777		# multiling http</span><br><span class="line">acl CONNECT method CONNECT</span><br><span class="line"></span><br><span class="line"><span class="addition">+ acl client src 192.168.242.165</span></span><br><span class="line"><span class="addition">+ http_access allow client</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+ auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/squid_passwd</span></span><br><span class="line"><span class="addition">+ auth_param basic children 5</span></span><br><span class="line"><span class="addition">+ auth_param basic realm Squid proxy-caching web server</span></span><br><span class="line"><span class="addition">+ auth_param basic credentialsttl 2 hours</span></span><br><span class="line"><span class="addition">+ auth_param basic casesensitive off</span></span><br><span class="line"><span class="addition">+ acl ncsa_users proxy_auth REQUIRED</span></span><br><span class="line"><span class="addition">+ http_access allow ncsa_users</span></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Recommended minimum Access Permission configuration:</span><br><span class="line">#</span><br><span class="line"># Deny requests to certain unsafe ports</span><br><span class="line">http_access deny !Safe_ports</span><br><span class="line"></span><br><span class="line"># Deny CONNECT to other than secure SSL ports</span><br><span class="line">http_access deny CONNECT !SSL_ports</span><br><span class="line"></span><br><span class="line"># Only allow cachemgr access from localhost</span><br><span class="line">http_access allow localhost manager</span><br><span class="line">http_access deny manager</span><br><span class="line"></span><br><span class="line"># We strongly recommend the following be uncommented to protect innocent</span><br><span class="line"># web applications running on the proxy server who think the only</span><br><span class="line"># one who can access services on &quot;localhost&quot; is a local user</span><br><span class="line">#http_access deny to_localhost</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Example rule allowing access from your local networks.</span><br><span class="line"># Adapt localnet in the ACL section to list your (internal) IP networks</span><br><span class="line"># from where browsing should be allowed</span><br><span class="line">http_access allow localnet</span><br><span class="line">http_access allow localhost</span><br><span class="line"></span><br><span class="line"># And finally deny all other access to this proxy</span><br><span class="line">http_access deny all</span><br><span class="line"></span><br><span class="line"># Squid normally listens to port 3128</span><br><span class="line">http_port 3128</span><br><span class="line"></span><br><span class="line"># Uncomment and adjust the following to add a disk cache directory.</span><br><span class="line">#cache_dir ufs /var/spool/squid 100 16 256</span><br><span class="line"></span><br><span class="line"># Leave coredumps in the first cache dir</span><br><span class="line">coredump_dir /var/spool/squid</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Add any of your own refresh_pattern entries above these.</span><br><span class="line">#</span><br><span class="line">refresh_pattern ^ftp:		1440	20%	10080</span><br><span class="line">refresh_pattern ^gopher:	1440	0%	1440</span><br><span class="line">refresh_pattern -i (/cgi-bin/|\?) 0	0%	0</span><br><span class="line">refresh_pattern .		0	20%	4320</span><br></pre></td></tr></table></figure>
<p>客户端ip为192.168.242.165不需要验证，直接能使用代理上网。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">acl client src 192.168.242.165</span><br><span class="line">http_access allow client</span><br></pre></td></tr></table></figure>
<p>其他能access the proxy的客户端都要认证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/squid_passwd</span><br><span class="line">auth_param basic children 5</span><br><span class="line">auth_param basic realm Squid proxy-caching web server</span><br><span class="line">auth_param basic credentialsttl 2 hours</span><br><span class="line">auth_param basic casesensitive off</span><br><span class="line">acl ncsa_users proxy_auth REQUIRED</span><br><span class="line">http_access allow ncsa_users</span><br></pre></td></tr></table></figure>
<p>如果去掉</p>
<div class="tag-plugin tabs" align="center"id="tab_228"><div class="nav-tabs"><div class="tab active"><a href="#tab_228-1">删减内容</a></div><div class="tab"><a href="#tab_228-2">完整版</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_228-1"><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- http_access allow client</span></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab_228-2"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">acl client src 192.168.242.165</span><br><span class="line"></span><br><span class="line">auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/squid_passwd</span><br><span class="line">auth_param basic children 5</span><br><span class="line">auth_param basic realm Squid proxy-caching web server</span><br><span class="line">auth_param basic credentialsttl 2 hours</span><br><span class="line">auth_param basic casesensitive off</span><br><span class="line">acl ncsa_users proxy_auth REQUIRED</span><br><span class="line">http_access allow ncsa_users</span><br></pre></td></tr></table></figure></div></div></div>
<p>192.168.242.165上网也需要认证，为什么？从现在的conf看，acl只是定义了client组，client组里有192.168.242.165这个客户端，然后遇到认证的那几条，并且只允许认证后的客户端的请求http_access allow ncsa_users。</p>
<blockquote>
<p>原因：</p>
<p>In your squid configuration file, the line “acl client src 192.168.242.165” defines an access control list (ACL) named “client” that includes only the IP address 192.168.242.165.</p>
<p>The next line “http_access allow client” grants access to this ACL without requiring authentication. Therefore, any client with the IP address 192.168.242.165 will be able to access the proxy server without authentication.</p>
<p>If you remove the line “http_access allow client”, all clients will require authentication including the client with the IP address 192.168.242.165.</p>
<p>Regarding the question about the need for authentication for clients on the localnet, the ACL “localnet” includes IP addresses from 10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16, which cover a range of private IP addresses. However, this does not automatically grant access to these clients without authentication. You still need to define an ACL and grant access accordingly, as you have done with the “client” ACL in your configuration file.</p>
</blockquote>
<p>因为acl只是定义了一个请求或客户端是否允许或拒绝访问代理服务器的条件，而http_access规则确定了根据这些条件的结果应该采取的行动。它们要一起搭配使用。</p>
<blockquote>
<p>An access control list (ACL) in Squid is used to define a list of conditions that are used to match requests or clients. ACLs are used in combination with http_access rules to determine which requests or clients are allowed to access the proxy server.</p>
<p>http_access rules in Squid are used to define the access policy for incoming requests. They are used to control which clients or requests are allowed or denied access to the proxy server, based on the conditions defined in the ACLs.</p>
<p>In other words, ACLs define the conditions that are used to determine whether a request or client is allowed or denied access to the proxy server, while http_access rules determine the actions that should be taken based on the results of these conditions.</p>
<p>For example, you might define an ACL that matches requests from a particular domain name, and then use an http_access rule to allow or deny access based on that ACL. Or, you might define an ACL that matches a particular IP address range, and then use an http_access rule to grant or deny access based on that ACL.</p>
<p>Overall, ACLs and http_access rules work together to provide granular control over which clients or requests are allowed to access the proxy server, and what actions should be taken for each request or client.</p>
</blockquote>
<h2 id="进阶配置未试只是记录"><a class="markdownIt-Anchor" href="#进阶配置未试只是记录"></a> 进阶配置（未试，只是记录）</h2>
<p><strong>匿名</strong></p>
<p>默认情况下，Squid 会添加很多和客户信息相关的 HTTP 头，如 X-Forwarded-For 这类。如果想要做到高度匿名，需要将这些头去掉。在 squid.conf 里面添加如下的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">forwarded_for off</span><br><span class="line">request_header_access Allow allow all</span><br><span class="line">request_header_access Authorization allow all</span><br><span class="line">request_header_access WWW-Authenticate allow all</span><br><span class="line">request_header_access Proxy-Authorization allow all</span><br><span class="line">request_header_access Proxy-Authenticate allow all</span><br><span class="line">request_header_access Cache-Control allow all</span><br><span class="line">request_header_access Content-Encoding allow all</span><br><span class="line">request_header_access Content-Length allow all</span><br><span class="line">request_header_access Content-Type allow all</span><br><span class="line">request_header_access Date allow all</span><br><span class="line">request_header_access Expires allow all</span><br><span class="line">request_header_access Host allow all</span><br><span class="line">request_header_access If-Modified-Since allow all</span><br><span class="line">request_header_access Last-Modified allow all</span><br><span class="line">request_header_access Location allow all</span><br><span class="line">request_header_access Pragma allow all</span><br><span class="line">request_header_access Accept allow all</span><br><span class="line">request_header_access Accept-Charset allow all</span><br><span class="line">request_header_access Accept-Encoding allow all</span><br><span class="line">request_header_access Accept-Language allow all</span><br><span class="line">request_header_access Content-Language allow all</span><br><span class="line">request_header_access Mime-Version allow all</span><br><span class="line">request_header_access Retry-After allow all</span><br><span class="line">request_header_access Title allow all</span><br><span class="line">request_header_access Connection allow all</span><br><span class="line">request_header_access Proxy-Connection allow all</span><br><span class="line">request_header_access User-Agent allow all</span><br><span class="line">request_header_access Cookie allow all</span><br><span class="line">request_header_access All deny all</span><br></pre></td></tr></table></figure>
<hr />
<p>也看到另一种高匿写法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request_header_access X-Forwarded-For deny all</span><br><span class="line">request_header_access From deny all</span><br><span class="line">request_header_access Via deny all</span><br></pre></td></tr></table></figure>
<hr />
<p><strong>去除相关主机信息</strong></p>
<p>默认情况下，Squid 会把主机相关的信息发送出去，并显示在错误页面。加上下面两句去掉这些信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">add this to /etc/squid/squid.conf</span></span><br><span class="line">visible_hostname mybogusproxyhostname.local</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and <span class="keyword">while</span> we are at it stop squid blabbing about it<span class="string">&#x27;s version aswell</span></span></span><br><span class="line">httpd_suppress_version_string on</span><br></pre></td></tr></table></figure>
<h2 id="使用代理"><a class="markdownIt-Anchor" href="#使用代理"></a> 使用代理</h2>
<h3 id="windows"><a class="markdownIt-Anchor" href="#windows"></a> Windows</h3>
<ol>
<li>
<p>老版本ie浏览器（比如win7下的），在ie浏览器<br />
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325150254514.png" alt="image-20230325150254514" /><br />
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325150412299.png" alt="image-20230325150412299" /><br />
如果有认证，会弹窗<br />
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325160609627.png" alt="image-20230325160609627" /></p>
</li>
<li>
<p>Google浏览器,使用默认的系统代理。</p>
</li>
<li>
<p>Edge浏览器，认证弹窗长这样：<br />
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325161410331.png" alt="image-20230325161410331" /><br />
表单保存<br />
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325161456672.png" alt="image-20230325161456672" /></p>
</li>
<li>
<p>Firefox<br />
常规-连接设置<br />
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325150057249.png" alt="image-20230325150057249" /></p>
</li>
</ol>
<p><strong>使用后</strong></p>
<p>使用代理的机器，可以看到与代理服务器之间的建连（请求一个网页是多文件请求，所以会有多连接）</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325162120741.png" alt="image-20230325162120741" /></p>
<p>squid上的日志可以看到</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/squid%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/image-20230325162331495.png" alt="image-20230325162331495" /></p>
<h3 id="linux"><a class="markdownIt-Anchor" href="#linux"></a> Linux</h3>
<blockquote>
<p>[<a target="_blank" rel="noopener" href="https://blog.51cto.com/zhangxueliang/2970035">Linux搭建squid服务实现内网机器代理上网</a>]</p>
</blockquote>



<div class="article-footer reveal fs14"></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/proxy_server_building/TMG%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8.html">TMG代理服务器</a></div></section></div>




      
<footer class="page-footer reveal fs12"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs14">博客</span><a href="/">近期发布</a><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs14">wiki</span><a href="/wiki/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a><a href="/wiki/tags/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/">安全技术</a><a href="/wiki/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">环境搭建</a><a href="/wiki/tags/%E5%85%B6%E4%BB%96/">其他</a></div><div class="sitemap-group"><span class="fs14">关于</span><a href="/about/">关于</a></div></div><div class="text"><p>本站由 <a href="/">Misc</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0">Stellar 1.25.0</a> 主题创建。<br />
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    
<script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = stellar.config.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.25.0';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
    root : '/',
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js","memos":"/js/plugins/memos.js","marked":"/js/plugins/marked.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@10.3/swiper-bundle.min.css","js":"https://unpkg.com/swiper@10.3/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".fancybox img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.copycode = Object.assign({"enable":true,"js":"/js/plugins/copycode.js","default_text":"Copy","success_text":"Copied","toast":"复制成功"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->






<!-- inject -->


  </div>
</body>
</html>
