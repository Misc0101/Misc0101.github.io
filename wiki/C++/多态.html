<!DOCTYPE html>
<html lang='zh-CN'>


<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0" theme-name="Stellar" theme-version="1.25.0">
  
  <meta name="generator" content="Hexo 7.1.1">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>C++：多态 - Misc010</title>

  
    <meta name="description" content="绑定（binding） 绑定：函数调用处与函数地址关联起来的过程 例 下面代码中void TestBound(Base* pb)函数的运行结果是什么？  x的输出是多少？ 调用的是哪个Function_1() 调用的是哪个Function_2()  12345678910111213141516171819202122232425262728293031323334353637383940414">
<meta property="og:type" content="website">
<meta property="og:title" content="多态">
<meta property="og:url" content="https://misc0101.github.io/wiki/C++/%E5%A4%9A%E6%80%81.html">
<meta property="og:site_name" content="Misc010">
<meta property="og:description" content="绑定（binding） 绑定：函数调用处与函数地址关联起来的过程 例 下面代码中void TestBound(Base* pb)函数的运行结果是什么？  x的输出是多少？ 调用的是哪个Function_1() 调用的是哪个Function_2()  12345678910111213141516171819202122232425262728293031323334353637383940414">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229111935696.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229162443296.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229160714486.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229160758415.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229160831937.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229160917342.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229162518872.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229161137916.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229161247570.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229161724774.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229161813412.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229161854904.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229162548653.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229165608397.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229162854094.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229170442696.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229170407765.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229170854962.png">
<meta property="og:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229170951708.png">
<meta property="article:published_time" content="2024-02-29T02:54:23.000Z">
<meta property="article:modified_time" content="2024-02-29T02:54:23.000Z">
<meta property="article:author" content="Misc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://misc0101.github.io/Typora_images/%E5%A4%9A%E6%80%81/image-20240229111935696.png">
  
  
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  

  

  
  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='wiki'>
    

  




<div class="widgets"><widget class="widget-wrapper logo-wrap wiki"><div class="widget-body"><a style="filter: grayscale(100%)" class="wiki-home cap" href="/wiki"><svg aria-hidden="true" viewBox="0 0 16 16" width="1.2em" height="1.2em" fill="currentColor"><path fill-rule="evenodd" d="M7.78 12.53a.75.75 0 01-1.06 0L2.47 8.28a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L4.81 7h7.44a.75.75 0 010 1.5H4.81l2.97 2.97a.75.75 0 010 1.06z"></path></svg>所有项目</a><a class="title" href="/wiki/C++/%E5%B0%81%E8%A3%85%E5%92%8Cthis%E6%8C%87%E9%92%88.html"><div class="main" ff="title">C++</div></a></div></widget>
<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search-wrapper"><form class="search-form"><input type="text" class="search-input" id="search-input" data-filter="/wiki/C++/" placeholder="在/wiki/C++/中搜索..."><svg t="1705074644177" class="icon search-icon" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div></div></widget>


<widget class="widget-wrapper toc multi" id="data-toc" collapse="false"><div class="widget-header cap dis-select"><span class="name">封装/隐藏实现</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%B0%81%E8%A3%85%E5%92%8Cthis%E6%8C%87%E9%92%88.html#start"><span class="toc-text">封装和this指针</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0.html"><span class="toc-text">构造函数和析构函数</span></a></div></div><div class="widget-header cap dis-select"><span class="name">继承</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E7%BB%A7%E6%89%BF.html"><span class="toc-text">继承</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E7%B1%BB%E6%88%90%E5%91%98%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6.html"><span class="toc-text">类成员的访问控制</span></a></div></div><div class="widget-header cap dis-select"><span class="name">基本概念-I</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%9C%A8%E5%A0%86%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1.html"><span class="toc-text">在堆中创建对象</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B.html"><span class="toc-text">引用类型</span></a></div></div><div class="widget-header cap dis-select"><span class="name">多态</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E8%99%9A%E5%87%BD%E6%95%B0.html"><span class="toc-text">虚函数</span></a></div><div class="doc-tree active"><a class="doc-tree-link active" href="/wiki/C++/%E5%A4%9A%E6%80%81.html"><span class="toc-text">多态</span></a><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%91%E5%AE%9Abinding"><span class="toc-text"> 绑定（binding）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#virtual-functions-constructors"><span class="toc-text"> virtual functions &amp; constructors</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#order-of-constructor-calls"><span class="toc-text"> Order of constructor calls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virtual-constructors-virtual-functions-inside-constructors"><span class="toc-text"> virtual constructors? &amp; virtual functions inside constructors</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#destructors-and-virtual-destructors"><span class="toc-text"> Destructors and virtual destructors</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#order-of-destructor-calls"><span class="toc-text"> Order of Destructor calls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virtual-destructors"><span class="toc-text"> virtual destructors</span></a></li></ol></li></ol></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/OOP%E4%B8%89%E5%A4%A7%E7%89%B9%E5%BE%81.html"><span class="toc-text">OOP三大特征</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E8%99%9A%E8%A1%A8.html"><span class="toc-text">虚表（简化版文章）</span></a></div></div><div class="widget-header cap dis-select"><span class="name">基本概念-II</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%8F%8B%E5%85%83.html"><span class="toc-text">友元</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD.html"><span class="toc-text">运算符重载</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%AF%B9%E8%B1%A1%E6%8B%B7%E8%B4%9D-%E6%8B%B7%E8%B4%9D%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0.html"><span class="toc-text">对象拷贝-拷贝构造函数</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%AF%B9%E8%B1%A1%E6%8B%B7%E8%B4%9D-%E9%87%8D%E8%BD%BD%E8%B5%8B%E5%80%BC%E8%BF%90%E7%AE%97%E7%AC%A6.html"><span class="toc-text">对象拷贝-重载赋值运算符</span></a></div></div><div class="widget-header cap dis-select"><span class="name">模板</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E6%A8%A1%E6%9D%BF.html"><span class="toc-text">模板</span></a></div></div><div class="widget-header cap dis-select"><span class="name">其他</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%86%85%E9%83%A8%E7%B1%BB%EF%BC%88%E5%B5%8C%E5%A5%97%E7%B1%BB%EF%BC%89.html"><span class="toc-text">内部类（嵌套类）</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E8%BF%90%E7%AE%97%E7%AC%A6.html"><span class="toc-text">强制类型转换运算符</span></a></div></div><div class="widget-header cap dis-select"><span class="name">总结</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/C++/%E5%B0%8F%E7%BB%93_C++.html"><span class="toc-text">小结</span></a></div></div></widget>

<widget class="widget-wrapper related"><div class="widget-header cap theme dis-select"><span class="name">更多：计算机基础</span></div><div class="widget-body related-posts"><a class="item wiki" href="/wiki/Assembly_Language/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8_%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99.html"><span class="title">汇编语言</span><span class="excerpt">x86汇编笔记：以滴水三期_汇编语言课程为框架，《汇编语言4th-王爽》和《汇编语言-基于x86处理器-第七版》为补充。</span></a><a class="item wiki" href="/wiki/C/%E5%87%BD%E6%95%B0.html"><span class="title">C</span><span class="excerpt">滴水三期_C语言笔记，以逆向角度看待和学习C语言，精彩点：堆栈图与指针。</span></a><a class="item wiki" href="/wiki/Modern_C++/%E7%B1%BB.html"><span class="title">Modern C++</span><span class="excerpt">C++98及其之前的C++ 特性称之为traditional C++（传统C++），C++11/14/17/20被称为Modern C++（现代 C++ ）。补充从传统C++“升级”到现代C++的知识。</span></a><a class="item wiki" href="/wiki/Proxy_Protocols/%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86_%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E6%8A%80%E6%9C%AF.html"><span class="title">科学上网技术</span><span class="excerpt">从正常网络通信数据包通信过程出发，逐步推导到使用代理协议进行科学上网，随后依次介绍各代理协议ss、trojan、vmess、vless原理与节点搭建，还有相关的工具、技术、概念介绍。</span></a><a class="item wiki" href="/wiki/Thinking_in_C++/Pointers.html"><span class="title">Thinking in C++</span><span class="excerpt">《Thinking in C++ vol 1》笔记，知识内化后的输出，少部分是摘抄，少用的细节不做记录用时在查，参考视频：《面向对象程序设计_C++_翁恺老师》。</span></a><a class="item wiki" href="/wiki/Windows_API/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81.html"><span class="title">Windows API编程</span><span class="excerpt">滴水三期_win32 api笔记，学习Windows API编程的困难并不在于函数参数参数众多或者英文不好这类表象原因，而是需要从Windows系统的整体知识架构出发来学习这些API，深入理解每个参数背后的含义和背景。如此，未来查阅MSDN时便不再像是看天书。</span></a><a class="item wiki" href="/wiki/representation_and_computation_of_data/%E8%BF%9B%E5%88%B6.html"><span class="title">数据的运算与表示</span><span class="excerpt">滴水三期_进制笔记，学习与理解进制、数据宽度、数的表示、位运算等概念。</span></a></div></widget>
</div>


    </aside>
    <div class='l_main'>
      
  





      


<div class="bread-nav fs12"><div class="left"><div id="breadcrumb"><a class="cap breadcrumb" id="home" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki/">项目</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/C++/%E5%B0%81%E8%A3%85%E5%92%8Cthis%E6%8C%87%E9%92%88.html">C++</a></div><div id="post-meta">
    <span>更新于&nbsp;<time datetime="2024-02-29T02:54:23.000Z">2024-02-29</time></span>
    </div></div></div>

<article class='md-text content wiki'>
<h1 class="article-title"><span>多态</span></h1>
<h2 id="绑定binding"><a class="markdownIt-Anchor" href="#绑定binding"></a> 绑定（binding）</h2>
<p>绑定：<code>函数调用处</code>与<code>函数地址</code>关联起来的过程</p>
<p><strong>例</strong></p>
<p>下面代码中<code>void TestBound(Base* pb)</code>函数的运行结果是什么？</p>
<ul>
<li>x的输出是多少？</li>
<li>调用的是哪个Function_1()</li>
<li>调用的是哪个Function_2()</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>				</span><br><span class="line">&#123;				</span><br><span class="line"><span class="keyword">public</span>:				</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line"><span class="keyword">public</span>:				</span><br><span class="line">    <span class="built_in">Base</span>()</span><br><span class="line">    &#123;			</span><br><span class="line">        x = <span class="number">1</span>;		</span><br><span class="line">    &#125;			</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Function_1</span><span class="params">()</span>				</span></span><br><span class="line"><span class="function">    </span>&#123;				</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Base::Function_1 called...\n&quot;</span>);				</span><br><span class="line">    &#125;				</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Function_2</span><span class="params">()</span>				</span></span><br><span class="line"><span class="function">    </span>&#123;				</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Base::Function_2 called...virtual\n&quot;</span>);				</span><br><span class="line">    &#125;				</span><br><span class="line">&#125;;				</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sub</span>:<span class="keyword">public</span> Base				</span><br><span class="line">&#123;				</span><br><span class="line"><span class="keyword">public</span>:				</span><br><span class="line">    <span class="type">int</span> x;			</span><br><span class="line"><span class="keyword">public</span>:				</span><br><span class="line">    <span class="built_in">Sub</span>()			</span><br><span class="line">    &#123;			</span><br><span class="line">        x = <span class="number">2</span>;		</span><br><span class="line">    &#125;			</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Function_1</span><span class="params">()</span>				</span></span><br><span class="line"><span class="function">    </span>&#123;				</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sub::Function_1 called...\n&quot;</span>);				</span><br><span class="line">    &#125;				</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Function_2</span><span class="params">()</span>				</span></span><br><span class="line"><span class="function">    </span>&#123;				</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sub::Function_2 called...virtual\n&quot;</span>);				</span><br><span class="line">    &#125;				</span><br><span class="line">&#125;;				</span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TestBound</span><span class="params">(Base* pb)</span>				</span></span><br><span class="line"><span class="function"></span>&#123;				</span><br><span class="line">    <span class="type">int</span> n = pb-&gt;x;			</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,n);			</span><br><span class="line">                </span><br><span class="line">    pb-&gt;<span class="built_in">Function_1</span>();		<span class="comment">//函数调用	</span></span><br><span class="line">                </span><br><span class="line">    pb-&gt;<span class="built_in">Function_2</span>();       <span class="comment">//函数调用				</span></span><br><span class="line">&#125;				</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span>				</span></span><br><span class="line"><span class="function"></span>&#123;				</span><br><span class="line">                    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;			</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到前面提的，绑定的过程就是函数调用处和函数地址相关联的过程。</p>
<ul>
<li>函数地址在程序编译时便能确定的，称为编译期绑定，又称前期绑定/早绑定(early binding)</li>
<li>函数地址在函数调用时才能确定的，称为运行期绑定，又称动态绑定/晚绑定(late binding)</li>
</ul>
<p>观察TestBound函数的反汇编代码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229111935696.png" alt="image-20240229111935696" /></p>
<p>观察到：</p>
<ul>
<li>x已经关联完了，this指针+4，就是父类的x，x写死了的（函数的参数是父类的指针，无论传入的是父类对象还是子类对象，从对象内存布局上看，this+4就是父类的x）</li>
<li><code>pb-&gt;Function_1();</code>，关联的就是父类的function1（Base::Function_1）</li>
<li>调对象虚表中的虚函数地址。但没法确定函数地址，因为传给TestBound函数的可以是父类对象，也可以是子类对象（传子类就是upcasting），传的对象不同，虚表就不同，虚表中的虚函数地址就不同。这里的绑定需要在程序运行时才能确定</li>
</ul>
<p>答案：</p>
<p>TestBound传Base对象和Sub对象，不同情况时的输出如下表</p>
<table>
<thead>
<tr>
<th></th>
<th>Base对象</th>
<th>Sub对象</th>
</tr>
</thead>
<tbody>
<tr>
<td>x的输出</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>Function_1()</td>
<td>Base::Function_1 called…</td>
<td>Base::Function_1 called…</td>
</tr>
<tr>
<td>Function_2()</td>
<td>Base::Function_2 called…virtual</td>
<td>Sub::Function_2 called…virtual</td>
</tr>
</tbody>
</table>
<p>像Function_2()这样，同样一个函数却能体现不同的行为，这便是多态。</p>
<blockquote>
<p>注意只有通过upcatsing（父类指针/引用指向子类对象）且调用virtual functions，才是late binding，才是多态</p>
</blockquote>
<h2 id="virtual-functions-constructors"><a class="markdownIt-Anchor" href="#virtual-functions-constructors"></a> virtual functions &amp; constructors</h2>
<blockquote>
<p>参考：《Thinking in c++》2th，P695-701</p>
</blockquote>
<h3 id="order-of-constructor-calls"><a class="markdownIt-Anchor" href="#order-of-constructor-calls"></a> Order of constructor calls</h3>
<p>构造函数的任务是确保对象<strong>built properly</strong>，包括VPTR被正确指向proper VTABLE，成员变量的初始化。</p>
<p>构造函数调用次序要按照基类到最晚派生类顺序的理由（ putting an object together piece-by-piece, first by calling the base constructor, then the more derived constructors in order of inheritance）：</p>
<ul>
<li>子类只能访问到父类中public和protected的成员，只有父类的构造函数才能初始化它自己的private成员</li>
<li>VPTR可能需要更新：父类中有虚函数时，父类的构造函数会将VPTR指向父类的VTABLE。如果子类重写了虚函数，VRTP又将设置为指向子类的VTABLE，以此类推，直到最后的构造函数结束。The state of the VPTR is determined by the constructor that is called last.</li>
</ul>
<h3 id="virtual-constructors-virtual-functions-inside-constructors"><a class="markdownIt-Anchor" href="#virtual-constructors-virtual-functions-inside-constructors"></a> virtual constructors? &amp; virtual functions inside constructors</h3>
<ol>
<li>
<p>构造函数为什么不能是虚函数？<br />
原因：构造函数负责对象的初始化，这时vptr都没建立完成，如何多态？</p>
</li>
<li>
<p>如果在构造函数中调用虚函数会发生什么？</p>
<p>vptr没完全正确的初始化，在后续的构造函数中可能会继续更新，这时的调用可能是灾难性的</p>
</li>
</ol>
<h2 id="destructors-and-virtual-destructors"><a class="markdownIt-Anchor" href="#destructors-and-virtual-destructors"></a> Destructors and virtual destructors</h2>
<h3 id="order-of-destructor-calls"><a class="markdownIt-Anchor" href="#order-of-destructor-calls"></a> Order of Destructor calls</h3>
<p>与构造函数相似，析构函数的工作是disassemble an object that may belong to a hierarchy of classes。但析构函数的调用顺序与构造函数顺序相反，这是因为：</p>
<ul>
<li>释放工作先由派生类析构属于自己的对象，然后向上到基类析构，这是安全且合理的（属于子类的成员析构完后，父类成员仍是有效的，子类的析构中仍可以调用父类的成员函数）</li>
</ul>
<div class="tag-plugin tabs" align="center"id="tab_46"><div class="nav-tabs"><div class="tab active"><a href="#tab_46-1">在栈中的对象</a></div><div class="tab"><a href="#tab_46-2">在堆中的对象</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_46-1"><p>以局部变量为例，全局变量在全局区，一样的，略</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Base</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Base() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Base</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;~Base() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Derived</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Derived() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Derived</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;~Derived() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Derived* d = <span class="keyword">new</span> <span class="built_in">Derived</span>();     <span class="comment">// 在堆上创建对象</span></span><br><span class="line">    <span class="keyword">delete</span> d;                       <span class="comment">// 释放对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229162443296.png" alt="image-20240229162443296" /></p>
<div class="tag-plugin tabs" align="center"id="tab_44"><div class="nav-tabs"><div class="tab active"><a href="#tab_44-1">构造函数顺序</a></div><div class="tab"><a href="#tab_44-2">析构函数顺序</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_44-1"><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229160714486.png" alt="image-20240229160714486" /></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229160758415.png" alt="image-20240229160758415" /></p></div><div class="tab-pane" id="tab_44-2"><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229160831937.png" alt="image-20240229160831937" /></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229160917342.png" alt="image-20240229160917342" /></p></div></div></div></div><div class="tab-pane" id="tab_46-2"><p>new方式创建的对象在堆中，用delete进行释放</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Base</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Base() called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Base</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;~Base() called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Derived</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Derived() called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Derived</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;~Derived() called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Derived *d = <span class="keyword">new</span> <span class="built_in">Derived</span>();  <span class="comment">// 在堆上创建对象</span></span><br><span class="line">    <span class="keyword">delete</span> d;                    <span class="comment">// 释放对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229162518872.png" alt="image-20240229162518872" /></p>
<div class="tag-plugin tabs" align="center"id="tab_45"><div class="nav-tabs"><div class="tab active"><a href="#tab_45-1">构造函数顺序</a></div><div class="tab"><a href="#tab_45-2">析构函数顺序</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_45-1"><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229161137916.png" alt="image-20240229161137916" /></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229161247570.png" alt="image-20240229161247570" /></p></div><div class="tab-pane" id="tab_45-2"><p>使用<code>delete</code>删除一个对象时，首先调用该对象的析构函数来清理资源，然后释放分配给该对象的内存。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229161724774.png" alt="image-20240229161724774" /></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229161813412.png" alt="image-20240229161813412" /></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229161854904.png" alt="image-20240229161854904" /></p></div></div></div></div></div></div>
<h3 id="virtual-destructors"><a class="markdownIt-Anchor" href="#virtual-destructors"></a> virtual destructors</h3>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/522415436/answer/2395074263">C++ 中的基类为何在析构函数中添加 virtual？ - 姚冬的回答 - 知乎</a></p>
</blockquote>
<p>写一个类，类的析构函数建议写成虚函数，确保当用基类类型的指针去delete一个派生类的实例的时候，可以让派生类的析构函数被调用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line">    ~<span class="built_in">Derived</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Base *p = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br><span class="line"><span class="keyword">delete</span> p;</span><br></pre></td></tr></table></figure>
<hr />
<p>这个情况发生在一个类被继承，然后开发者会写多态的代码（upcasting + new方式的对象），但释放时如果父类的析构函数不是虚函数，释放对象时只会调用父类的析构函数，这样就只释放掉父类对象的内存，而子类对象相比于父类多出来的那部分并没有释放掉。</p>
<blockquote>
<p>对象在堆栈或全局变量区是没这个问题的，当对象的生命周期结束时（如函数返回，或，程序结束），对象销毁时，它们的析构函数会按照正确的顺序执行（先派生类，后基类）</p>
</blockquote>
<p><strong>例</strong></p>
<p>构造函数顺序：<code>Base()</code>-&gt;<code>Derived()</code><br />
析构函数顺序：<code>~Derived()</code>-&gt;<code>~Base()</code></p>
<div class="tag-plugin tabs" align="center"id="tab_47"><div class="nav-tabs"><div class="tab active"><a href="#tab_47-1">非虚析构函数</a></div><div class="tab"><a href="#tab_47-2">虚析构函数</a></div></div><div class="tab-content"><div class="tab-pane active" id="tab_47-1"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Base</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Base() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Base</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;~Base() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Derived</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Derived() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Derived</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;~Derived() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Base* p = <span class="keyword">new</span> <span class="built_in">Derived</span>();        <span class="comment">// 父类指针指向子类对象</span></span><br><span class="line">    <span class="keyword">delete</span> p;                       <span class="comment">// 释放时只会调用父类的析构</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只调用了~Base()</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229162548653.png" alt="image-20240229162548653" /></p>
<p>跟进delete的反汇编看什么情况。</p>
<blockquote>
<p>前面new得到一个堆中的内存地址，用eax存到局部变量区[ebp-18h]，将[ebp-18h]作为this指针传给构造函数进行初始化。</p>
<p>delelte时也是传这内存编号，push 1猜是因为只有1个对象要销毁，如果delete []要算一共多少个对象</p>
</blockquote>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229165608397.png" alt="image-20240229165608397" /></p>
<blockquote>
<p>使用<code>delete</code>删除一个对象时，首先调用该对象的析构函数来清理资源，然后释放分配给该对象的内存。</p>
</blockquote>
<p>因为是<code>Base*</code>类型指针，这里传this指针然后调用Base类的析构函数</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229162854094.png" alt="image-20240229162854094" /></p></div><div class="tab-pane" id="tab_47-2"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Base</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        x = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Base() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;~Base() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Derived</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        y = <span class="number">2</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Derived() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Derived</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;~Derived() called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Base* p = <span class="keyword">new</span> <span class="built_in">Derived</span>(); <span class="comment">// 父类指针指向子类对象</span></span><br><span class="line">    <span class="keyword">delete</span> p;                <span class="comment">// 析构函数会多态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229170442696.png" alt="image-20240229170442696" /></p>
<p>析构时正确了，看反汇编和非析构函数的区别。</p>
<p>看到delete时call变成了间接调用虚表，[ebp-1Ch]是new返回的堆的内存地址，然后得到vptr（mov edx,dword ptr [ecx]），然后去虚表调用虚函数地址（call dword ptr [edx]），在下方的变量监视窗口看到虚表中是Derived::~scalar deleting destructor</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229170407765.png" alt="image-20240229170407765" /></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229170854962.png" alt="image-20240229170854962" /></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../Typora_images/%E5%A4%9A%E6%80%81/image-20240229170951708.png" alt="image-20240229170951708" /></p></div></div></div>
<p>构造函数和析构函数是编译器在编译时帮我们插入生成的，其实它们也是个函数。使用父类指针指向子类对象时，如果父类析构函数不是虚函数，那么delete p时，编译器只知道调用Base类的析构函数。而将Base类中的析构函数写成虚析构函数时，<code>delete p</code>会发生多态，根据具体的对象，来调用那个对象的析构函数（Sound familiar? This is the same problem that virtual functions were created to solve for the general case. Fortunately, virtual functions work for destructors as they do for all other functions except constructors. ）</p>
<p><strong>小结</strong></p>
<p>写一个类时，将析构函数写成虚函数是一个好的做法。因为你并不知道其他人在使用这个代码时会不会继承这个类，然后用基类类型的指针去delete一个派生类实例。</p>
<p>是一个好的做法，尤其是在涉及继承时，因为它确保了当通过基类指针删除派生类对象时，适当的析构函数被调用</p>
<p><strong>开发中忽略了将父类析构函数声明为虚析构函数的例子</strong></p>
<p>咔咔写了使用多态的代码（arr[i]-&gt;Print();），用了new的方式，用了upcasting（父类指针指向子类对象），最后delete时会有隐藏的陷阱（只释放了父类的对象内容）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TestBound</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Base* arr[] = &#123;<span class="keyword">new</span> <span class="built_in">Base</span>(), <span class="keyword">new</span> <span class="built_in">Sub1</span>(), <span class="keyword">new</span> <span class="built_in">Sub2</span>()&#125;; <span class="comment">// 使用 new 创建对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) </span><br><span class="line">    &#123;</span><br><span class="line">        arr[i]-&gt;<span class="built_in">Print</span>();                <span class="comment">//多态</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> arr[i];                  <span class="comment">// 删除对象时没多态，只调用父类的析构函数</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Base</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        a = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Base() called. Set a = 1\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Base</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Base destructor called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Print</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Base::Print() called: a=%d\n&quot;</span>, a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sub1</span> : <span class="keyword">public</span> Base </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sub1</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        a = <span class="number">2</span>;</span><br><span class="line">        x = <span class="number">10</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sub1() called. Set a=2 and x=10\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Sub1</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sub1 destructor called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sub1::Print() called: a=%d, x=%d\n&quot;</span>, a, x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sub2</span> : <span class="keyword">public</span> Base </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sub2</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        a = <span class="number">3</span>;</span><br><span class="line">        y = <span class="number">20</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sub2() called. Set a=3 and y=20\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Sub2</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sub2 destructor called\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sub2::Print() called: a=%d, y=%d\n&quot;</span>, a, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TestBound</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Base* arr[] = &#123;<span class="keyword">new</span> <span class="built_in">Base</span>(), <span class="keyword">new</span> <span class="built_in">Sub1</span>(), <span class="keyword">new</span> <span class="built_in">Sub2</span>()&#125;; <span class="comment">// 使用 new 创建对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) </span><br><span class="line">    &#123;</span><br><span class="line">        arr[i]-&gt;<span class="built_in">Print</span>();                <span class="comment">//多态</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> arr[i];                  <span class="comment">// 删除对象时没多态，只调用父类的析构函数</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">TestBound</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<div class="article-footer reveal fs14"></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/C++/%E8%99%9A%E5%87%BD%E6%95%B0.html">虚函数</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/C++/OOP%E4%B8%89%E5%A4%A7%E7%89%B9%E5%BE%81.html">OOP三大特征</a></div></section></div>




      
<footer class="page-footer reveal fs12"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs14">博客</span><a href="/">近期发布</a><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs14">wiki</span><a href="/wiki/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a><a href="/wiki/tags/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/">安全技术</a><a href="/wiki/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">环境搭建</a><a href="/wiki/tags/%E5%85%B6%E4%BB%96/">其他</a></div><div class="sitemap-group"><span class="fs14">关于</span><a href="/about/">关于</a></div></div><div class="text"><p>本站由 <a href="/">Misc</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0">Stellar 1.25.0</a> 主题创建。<br />
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    
<script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = stellar.config.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.25.0';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
    root : '/',
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js","memos":"/js/plugins/memos.js","marked":"/js/plugins/marked.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@10.3/swiper-bundle.min.css","js":"https://unpkg.com/swiper@10.3/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".fancybox img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.copycode = Object.assign({"enable":true,"js":"/js/plugins/copycode.js","default_text":"Copy","success_text":"Copied","toast":"复制成功"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->






<!-- inject -->


  </div>
</body>
</html>
